services:
  # Aria2 Download Manager (for RDTClient)
  aria2:
    image: p3terx/aria2-pro:latest
    container_name: aria2
    restart: unless-stopped
    ports:
      - "6800:6800"       # RPC port
      - "6888:6888"       # BitTorrent port
      - "6888:6888/udp"
    volumes:
      - ./config/aria2:/config
      - /Volumes/the-eagle/media:/media
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
      - RPC_SECRET=rdtclient123
      - RPC_PORT=6800
      - LISTEN_PORT=6888
      - DISK_CACHE=64M
      - IPV6_MODE=false
      - UPDATE_TRACKERS=true
      - CUSTOM_TRACKER_URL=
    networks:
      - media-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -X POST http://localhost:6800/jsonrpc -H 'Content-Type: application/json' -d '{\"jsonrpc\":\"2.0\",\"id\":\"1\",\"method\":\"aria2.getVersion\",\"params\":[\"token:rdtclient123\"]}' | grep -q version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Real-Debrid Download Client
  rdtclient:
    image: rogerfar/rdtclient:latest
    container_name: rdtclient
    restart: unless-stopped
    ports:
      - "${RDTCLIENT_PORT:-6500}:6500"
    volumes:
      - ./config/rdtclient:/data/db
      - /Volumes/the-eagle/media:/media
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
      - Logging__LogLevel__Default=Warning
      - Logging__LogLevel__Microsoft=Warning
    networks:
      - media-network
    depends_on:
      aria2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6500"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Indexer Manager
  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    ports:
      - "${PROWLARR_PORT:-9696}:9696"
    volumes:
      - ./config/prowlarr:/config
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Movie Management
  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    ports:
      - "${RADARR_PORT:-7878}:7878"
    volumes:
      - ./config/radarr:/config
      - /Volumes/the-eagle/media:/media
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    depends_on:
      rdtclient:
        condition: service_healthy
      prowlarr:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # TV Show Management
  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    ports:
      - "${SONARR_PORT:-8989}:8989"
    volumes:
      - ./config/sonarr:/config
      - /Volumes/the-eagle/media:/media
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    depends_on:
      rdtclient:
        condition: service_healthy
      prowlarr:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Subtitle Management
  bazarr:
    image: linuxserver/bazarr:latest
    container_name: bazarr
    restart: unless-stopped
    ports:
      - "${BAZARR_PORT:-6767}:6767"
    volumes:
      - ./config/bazarr:/config
      - /Volumes/the-eagle/media:/media
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    depends_on:
      radarr:
        condition: service_healthy
      sonarr:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Media Server
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    ports:
      - "${JELLYFIN_PORT:-8096}:8096"
    volumes:
      - ./config/jellyfin:/config
      - /Volumes/the-eagle/media/movies:/data/movies:ro
      - /Volumes/the-eagle/media/tv:/data/tv:ro
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    # Hardware acceleration for Apple Silicon (optional)
    # Uncomment if you want to enable hardware transcoding
    # devices:
    #   - /dev/dri:/dev/dri
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Request Management UI
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    restart: unless-stopped
    ports:
      - "${JELLYSEERR_PORT:-5055}:5055"
    volumes:
      - ./config/jellyseerr:/app/config
    environment:
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    depends_on:
      jellyfin:
        condition: service_healthy
      radarr:
        condition: service_healthy
      sonarr:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5055"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Cloudflare Bypass
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    ports:
      - "${FLARESOLVERR_PORT:-8191}:8191"
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8191/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  media-network:
    driver: bridge
    name: media-network
