services:
  # Aria2 Download Manager (for RDTClient)
  aria2:
    image: p3terx/aria2-pro:latest
    container_name: aria2
    restart: unless-stopped
    ports:
      - "6800:6800"       # RPC port
      - "6888:6888"       # BitTorrent port
      - "6888:6888/udp"
    volumes:
      - ./config/aria2:/config
      - /Volumes/the-eagle/media:/media
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
      - RPC_SECRET=rdtclient123
      - RPC_PORT=6800
      - LISTEN_PORT=6888
      - DISK_CACHE=64M
      - IPV6_MODE=false
      - UPDATE_TRACKERS=true
      - CUSTOM_TRACKER_URL=
    networks:
      - media-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -X POST http://localhost:6800/jsonrpc -H 'Content-Type: application/json' -d '{\"jsonrpc\":\"2.0\",\"id\":\"1\",\"method\":\"aria2.getVersion\",\"params\":[\"token:rdtclient123\"]}' | grep -q version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Real-Debrid Download Client
  rdtclient:
    image: rogerfar/rdtclient:latest
    container_name: rdtclient
    restart: unless-stopped
    ports:
      - "${RDTCLIENT_PORT:-6500}:6500"
    volumes:
      - ./config/rdtclient:/data/db
      - /Volumes/the-eagle/media:/media
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
      - Logging__LogLevel__Default=Warning
      - Logging__LogLevel__Microsoft=Warning
    networks:
      - media-network
    depends_on:
      aria2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6500"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Indexer Manager
  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    ports:
      - "${PROWLARR_PORT:-9696}:9696"
    volumes:
      - ./config/prowlarr:/config
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    dns:
      - 1.1.1.1
      - 1.0.0.1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Movie Management
  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    ports:
      - "${RADARR_PORT:-7878}:7878"
    volumes:
      - ./config/radarr:/config
      - /Volumes/the-eagle/media:/media
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    dns:
      - 1.1.1.1
      - 1.0.0.1
    depends_on:
      rdtclient:
        condition: service_healthy
      prowlarr:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # TV Show Management
  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    ports:
      - "${SONARR_PORT:-8989}:8989"
    volumes:
      - ./config/sonarr:/config
      - /Volumes/the-eagle/media:/media
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    dns:
      - 1.1.1.1
      - 1.0.0.1
    depends_on:
      rdtclient:
        condition: service_healthy
      prowlarr:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Subtitle Management
  bazarr:
    image: linuxserver/bazarr:latest
    container_name: bazarr
    restart: unless-stopped
    ports:
      - "${BAZARR_PORT:-6767}:6767"
    volumes:
      - ./config/bazarr:/config
      - /Volumes/the-eagle/media:/media
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    depends_on:
      radarr:
        condition: service_healthy
      sonarr:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Media Server
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    ports:
      - "${JELLYFIN_PORT:-8096}:8096"
    volumes:
      - ./config/jellyfin:/config
      - /Volumes/the-eagle/media/movies:/data/movies:ro
      - /Volumes/the-eagle/media/tv:/data/tv:ro
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    # Hardware acceleration for Apple Silicon (optional)
    # Uncomment if you want to enable hardware transcoding
    # devices:
    #   - /dev/dri:/dev/dri
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Request Management UI
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    restart: unless-stopped
    ports:
      - "${JELLYSEERR_PORT:-5055}:5055"
    volumes:
      - ./config/jellyseerr:/app/config
    environment:
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    depends_on:
      jellyfin:
        condition: service_healthy
      radarr:
        condition: service_healthy
      sonarr:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5055"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Cloudflare Bypass
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    ports:
      - "${FLARESOLVERR_PORT:-8191}:8191"
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    dns:
      - 1.1.1.1
      - 1.0.0.1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8191/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Music Management (like Radarr for music)
  lidarr:
    image: linuxserver/lidarr:latest
    container_name: lidarr
    restart: unless-stopped
    ports:
      - "${LIDARR_PORT:-8686}:8686"
    volumes:
      - ./config/lidarr:/config
      - /Volumes/the-eagle/media:/media
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - media-network
    dns:
      - 1.1.1.1
      - 1.0.0.1
    depends_on:
      rdtclient:
        condition: service_healthy
      prowlarr:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8686"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Music Streaming Server (Subsonic API)
  navidrome:
    image: deluan/navidrome:latest
    container_name: navidrome
    restart: unless-stopped
    ports:
      - "${NAVIDROME_PORT:-4533}:4533"
    volumes:
      - ./config/navidrome:/data
      - /Volumes/the-eagle/media/music:/music:ro
    environment:
      - ND_SCANSCHEDULE=1h
      - ND_LOGLEVEL=info
      - ND_SESSIONTIMEOUT=24h
      - ND_BASEURL=
    user: "${PUID:-1000}:${PGID:-1000}"
    networks:
      - media-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4533/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Deezer FLAC Downloader (web UI)
  deemix:
    image: registry.gitlab.com/bockiii/deemix-docker:latest
    container_name: deemix
    restart: unless-stopped
    ports:
      - "${DEEMIX_PORT:-6595}:6595"
    volumes:
      - ./config/deemix:/config
      - /Volumes/the-eagle/media/music:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - DEEMIX_SINGLE_USER=true
      - ARL=${DEEZER_ARL}
    networks:
      - media-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6595"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Spotify Playlist Downloader (run on-demand)
  # Usage: docker compose run --rm spotdl --cookie-file /config/cookies.txt download "spotify_url"
  # Requires YouTube cookies - export from browser to config/spotdl/cookies.txt
  spotdl:
    image: spotdl/spotify-downloader:latest
    container_name: spotdl
    profiles:
      - tools
    volumes:
      - /Volumes/the-eagle/media/music:/music
      - ./config/spotdl:/config
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    working_dir: /music
    networks:
      - media-network

  # Cloudflare Tunnel - Secure external access without port forwarding
  # Public hostnames: watch.maxmerize.watch, request.maxmerize.watch
  # Configure in: Cloudflare Zero Trust → Networks → Tunnels → Public Hostnames
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - media-network
    depends_on:
      jellyfin:
        condition: service_healthy
      jellyseerr:
        condition: service_healthy

networks:
  media-network:
    driver: bridge
    name: media-network
